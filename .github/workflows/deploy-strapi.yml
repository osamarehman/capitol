name: Deploy Strapi to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'strapi/**'
      - '.github/workflows/deploy-strapi.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/strapi

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./strapi
          file: ./strapi/Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: true
          build-args: |
            NODE_ENV=production
            CACHE_BUST=${{ github.sha }}

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare VPS Environment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            echo "=== Preparing VPS Environment ==="

            # Update package list
            echo "Updating package list..."
            sudo apt-get update -qq

            # Check and install Docker
            if ! command -v docker &> /dev/null; then
              echo "Docker not found. Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              rm get-docker.sh
              echo "Docker installed successfully"
            else
              echo "Docker is already installed: $(docker --version)"
            fi

            # Check and install Docker Compose plugin
            if ! docker compose version &> /dev/null; then
              echo "Docker Compose plugin not found. Installing..."
              sudo apt-get install -y docker-compose-plugin
              echo "Docker Compose installed successfully"
            else
              echo "Docker Compose is already installed: $(docker compose version)"
            fi

            # Install wget if not present (needed for health checks)
            if ! command -v wget &> /dev/null; then
              echo "Installing wget..."
              sudo apt-get install -y wget
            fi

            # Install curl if not present (needed for health checks)
            if ! command -v curl &> /dev/null; then
              echo "Installing curl..."
              sudo apt-get install -y curl
            fi

            # Create deployment directory
            if [ ! -d "/opt/strapi" ]; then
              echo "Creating /opt/strapi directory..."
              sudo mkdir -p /opt/strapi
              sudo chown $USER:$USER /opt/strapi
              echo "Directory created: /opt/strapi"
            else
              echo "Directory already exists: /opt/strapi"
              # Ensure correct ownership
              sudo chown $USER:$USER /opt/strapi
            fi

            # Verify directory permissions
            ls -la /opt/ | grep strapi

            echo "=== Environment preparation complete ==="
            echo ""
            echo "System Information:"
            echo "- Docker: $(docker --version)"
            echo "- Docker Compose: $(docker compose version)"
            echo "- Wget: $(wget --version | head -1)"
            echo "- Curl: $(curl --version | head -1)"
            echo "- Deployment directory: /opt/strapi"

      - name: Copy docker-compose to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          source: "strapi/docker-compose.prod.yml"
          target: "/opt/strapi/"
          strip_components: 1

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          envs: GITHUB_TOKEN
          script: |
            cd /opt/strapi

            # Create .env file with secrets
            cat > .env << 'ENVEOF'
            DATABASE_NAME=${{ secrets.DATABASE_NAME }}
            DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}
            DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            ADMIN_JWT_SECRET=${{ secrets.ADMIN_JWT_SECRET }}
            APP_KEYS=${{ secrets.APP_KEYS }}
            API_TOKEN_SALT=${{ secrets.API_TOKEN_SALT }}
            TRANSFER_TOKEN_SALT=${{ secrets.TRANSFER_TOKEN_SALT }}
            STRAPI_URL=https://cms.improveitmd.com
            GITHUB_REPOSITORY=${{ github.repository }}
            IMAGE_TAG=${{ needs.build.outputs.image_tag }}
            ENVEOF

            # Login to GitHub Container Registry
            echo $GITHUB_TOKEN | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull latest image and force recreate containers
            docker compose -f docker-compose.prod.yml pull --ignore-pull-failures
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml up -d --force-recreate

            # Clean up old images
            docker image prune -f

            # Wait for Strapi to start
            echo "Waiting for Strapi to start..."
            sleep 45

            # Verify deployment
            if curl -sf http://localhost:1337/_health > /dev/null; then
              echo "Deployment successful! Strapi is healthy."
            else
              echo "Warning: Health check failed, but container may still be starting."
              docker compose -f docker-compose.prod.yml logs --tail=50 strapi
            fi

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ needs.build.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Production URL:** https://cms.improveitmd.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin Panel:** https://cms.improveitmd.com/admin" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: failure()
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Deployment Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Deployment Failure

            The Strapi deployment pipeline failed.

            - **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - **Commit:** ${{ github.sha }}
            - **Branch:** ${{ github.ref_name }}
            - **Triggered by:** ${{ github.actor }}

            Please check the workflow logs for details.
            `;

            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'deployment-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['deployment-failure', 'bug']
              });
            }
