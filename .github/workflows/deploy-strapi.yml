name: Deploy Strapi to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'strapi/**'
      - '.github/workflows/deploy-strapi.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Build and Deploy on VPS
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy Strapi source to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          source: "strapi/"
          target: "/opt/strapi-build/"
          strip_components: 0
          overwrite: true
          rm: true

      - name: Build and Deploy on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          command_timeout: 30m
          script: |
            set -e
            echo "=== Starting Strapi Build and Deploy ==="

            # Ensure directories exist
            sudo mkdir -p /opt/strapi /opt/strapi-build
            sudo chown -R $USER:$USER /opt/strapi /opt/strapi-build

            cd /opt/strapi-build/strapi

            # Create .env file for build
            cat > .env << 'ENVEOF'
            DATABASE_NAME=${{ secrets.DATABASE_NAME }}
            DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}
            DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            ADMIN_JWT_SECRET=${{ secrets.ADMIN_JWT_SECRET }}
            APP_KEYS=${{ secrets.APP_KEYS }}
            API_TOKEN_SALT=${{ secrets.API_TOKEN_SALT }}
            TRANSFER_TOKEN_SALT=${{ secrets.TRANSFER_TOKEN_SALT }}
            STRAPI_URL=https://cms.improveitmd.com
            ENVEOF

            echo "=== Cleaning Docker cache and old images ==="
            # Stop running containers first
            docker compose -f docker-compose.prod.yml down 2>/dev/null || true

            # Remove old strapi images to force fresh build
            docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' | grep -E 'strapi|capitol' | awk '{print $2}' | xargs -r docker rmi -f 2>/dev/null || true

            # Clean build cache
            docker builder prune -f --filter "until=24h" 2>/dev/null || true

            # Clean dangling images and volumes
            docker image prune -f
            docker volume prune -f 2>/dev/null || true

            echo "=== Building Docker image (native ARM64) ==="
            # Build with no cache to ensure fresh build
            docker compose -f docker-compose.prod.yml build --no-cache --pull

            echo "=== Starting services ==="
            docker compose -f docker-compose.prod.yml up -d --force-recreate

            # Copy docker-compose to deployment directory for future reference
            cp docker-compose.prod.yml /opt/strapi/
            cp .env /opt/strapi/

            echo "=== Waiting for Strapi to start ==="
            sleep 30

            # Health check with retries
            MAX_RETRIES=6
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -sf http://localhost:1337/_health > /dev/null 2>&1; then
                echo "✅ Strapi is healthy!"
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Waiting for Strapi... (attempt $RETRY_COUNT/$MAX_RETRIES)"
              sleep 10
            done

            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "⚠️ Health check timed out. Checking logs..."
              docker compose -f docker-compose.prod.yml logs --tail=100 strapi
              exit 1
            fi

            echo "=== Final cleanup ==="
            docker image prune -f

            echo "=== Deployment complete ==="
            docker compose -f docker-compose.prod.yml ps

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Production URL:** https://cms.improveitmd.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin Panel:** https://cms.improveitmd.com/admin" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Method:** Native ARM64 on VPS" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Deployment Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Deployment Failure

            The Strapi deployment pipeline failed.

            - **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - **Commit:** ${{ github.sha }}
            - **Branch:** ${{ github.ref_name }}
            - **Triggered by:** ${{ github.actor }}

            Please check the workflow logs for details.
            `;

            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'deployment-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['deployment-failure', 'bug']
              });
            }
